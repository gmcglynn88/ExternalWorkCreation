async function createInteraction(token) {
  const queueId = document.getElementById('queueSelect').value;
  const userId = document.getElementById('userSelect').value;
  const externalReference = document.getElementById('externalReference').value;
  const mediaType = document.getElementById('mediaTypeSelect').value; // Get selected media type

  // Determine API endpoint and payload based on the selected media type
  let apiEndpoint = '';
  let payload = {};

  switch (mediaType) {
    case 'voice':
      apiEndpoint = 'https://api.mypurecloud.ie/api/v2/conversations/calls';
      payload = {
        queueId: queueId,
        provider: 'QualityForm',
        direction: 'INBOUND',
        fromName: 'External Work Caller',
        priority: 0,
        attributes: {
          'External Link': externalReference
        },
        participants: [
          {
            address: 'external_work@provider.com', // Placeholder
            name: 'External Work Caller',
            userId: userId,
            queueId: queueId
          }
        ]
      };
      break;

    case 'email':
      apiEndpoint = 'https://api.mypurecloud.ie/api/v2/conversations/emails';
      payload = {
        queueId: queueId,
        provider: 'QualityForm',
        direction: 'INBOUND',
        fromName: 'External Work',
        attributes: { 'External Link': externalReference }
      };
      break;

    default:
      console.error('Invalid media type selected');
      return;
  }

  try {
    // Make API call to create interaction
    const interactionResponse = await fetch(apiEndpoint, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    if (!interactionResponse.ok) {
      throw new Error(`Error creating interaction: ${interactionResponse.status} ${interactionResponse.statusText}`);
    }

    const interaction = await interactionResponse.json();
    
    // Log the response to check if the `id` field exists
    console.log('Interaction Response:', interaction);

    // Check if the interaction has an `id`
    if (!interaction.id) {
      throw new Error('Interaction ID is undefined');
    }

    const conversationId = interaction.id;

    // Fetch conversation details
    const conversationDetailsResponse = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/${conversationId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!conversationDetailsResponse.ok) {
      throw new Error(`Error fetching conversation details: ${conversationDetailsResponse.status} ${conversationDetailsResponse.statusText}`);
    }

    const conversationDetails = await conversationDetailsResponse.json();
    
    // Log conversation details to debug
    console.log('Conversation Details:', conversationDetails);

    // Check if `participants` exist and if we can access the second participant
    if (!conversationDetails.participants || conversationDetails.participants.length < 2 || !conversationDetails.participants[1].id) {
      throw new Error('Participant ID is undefined');
    }

    const participantId = conversationDetails.participants[1].id;

    // Assign user to the conversation
    const assignResponse = await fetch(`${apiEndpoint}/${conversationId}/participants/${participantId}/replace`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ userId: userId })
    });

    if (!assignResponse.ok) {
      throw new Error(`Error assigning user: ${assignResponse.status} ${assignResponse.statusText}`);
    }

    // Disconnect the conversation
    const disconnectResponse = await fetch(`${apiEndpoint}/${conversationId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ state: 'disconnected' })
    });

    if (!disconnectResponse.ok) {
      throw new Error(`Error disconnecting conversation: ${disconnectResponse.status} ${disconnectResponse.statusText}`);
    }

    // Display success message
    document.getElementById('statusMessage').innerText = 'Interaction created and assigned successfully!';

  } catch (error) {
    console.error('Error during interaction creation:', error);
    document.getElementById('statusMessage').innerText = `Error: ${error.message}`;
  }
}
